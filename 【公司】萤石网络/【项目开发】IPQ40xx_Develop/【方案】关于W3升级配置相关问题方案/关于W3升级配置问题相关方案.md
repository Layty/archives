## W3升级新版本配置相关问题

#### 问题概述
嵌入式系统，通常有一部分系统与用户数据会存于可持久存储的Flash中，当新版本这部分数据被更改，由于是持久保存，即使是版本升级，如果没有显示地还原默认配置操作，这些数据是不会被更改的。因此，如果当新版本修改了这部分数据，且依赖这部分数据才可正常运行的时候，便会发生问题。

W3采用的是Openwrt系统，有两部分数据是被永久存储的。

1. openwrt使用了一种称为overlayfs的文件系统，会将根目录下除了虚拟文件系统外的所有做过更改的文件保存起来。例如/etc、/bin、/sbin、/lib目录下内容。
1. openwrt的uci配置区域。

举两个典型的问题场景

1. 新版本需要在启动时增加部分操作，修改了/etc目录下的rc.local文件，升级后发现rc.local还是之前的内容，没有运行启动时我们需要操作，发生了错误。
1. 新版本发现一处配置不合理，比如要将MTU从1480改成1500，修改了uci配置，升级后发现MTU还是之前的1480，发生了错误。

#### 问题详解
**目标：我们需要保证更新数据的同时不会更新用户的配置，保证用户的体验。**

分析将被更新的数据，有如下特点：

1. overlayfs中的应用，脚本，启动文件这些跟用户配置不直接相关。
1. 用户配置仅存储在UCI配置之中，但相当分散，很难被抽取集中管理。
1. UCI配置大部分是通过openwrt脚本动态生成，需要手动去更新的配置项并不多。


综上所述：

1. overlayfs中的应用，脚本，启动文件,可以被直接覆盖更新。
1. UCI配置的更新，能用脚本生成尽量用脚本生成，不行的则通过版本号来进行维护管理，此类修改理应不多，可以承受其维护管理成本。























#### 解决方案

设备启动流程

1、设备启动完成之后，将设备版本号与uci配置中hik\_soft\_version进行版本号对比。

2a、设备版本号 < hik\_soft_version，不做任何操作。
 
2b、设备版本号 = hik\_soft_version，不做任何操作。

2c、设备版本号 > hik\_soft_version，调用hik\_data\_update.sh脚本，进行数据更新流程。

3、重启设备


数据更新流程

1. 在/overlay目录里，删除/overlay/etc/config目录外的所有文件与目录，即为覆盖了应用，脚本，启动文件。
2. 通过版本号对部分特殊配置进行更新管理。


#### 方案讨论
1. 产品的版本号存放。