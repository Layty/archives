## 低功耗协议方案

### 介绍
方案采用BK5812芯片作为收发器，工作在2.4~2.5GHz频率，最高理论速率可达6Mbps，适合于低功率场合

### 描述


### 协议
#### 1、信道选择
- 目的：选择一个比较干净的信道，避免干扰。
- 同频干扰源大致有WLAN、2.4G低速设备、2.4G高速设备。

WLAN带宽很高，基本覆盖2.4GHz整个频带，但由于BK5812只占用1Mhz带宽，可以选择WLAN网络的边缘信道以减少干扰。中国WLAN的可用中心频率为2412~2472Ghz，带宽为20Mhz。因此，BK5812可选择频率有2400~2402Mhz和2482~2500Mhz。

2.4Ghz低速设备，包含蓝牙、zigbee等设备，通常低速设备带宽是1Mhz，信道也是完全重合，需要通过载波监听来发现避让，可选信道很多，完全冲突的概率很小。

2.4Ghz高速设备，包含无绳电话、无线耳机等设备，此类设备干扰性最强，影响最大，只能通过载波监听来尽量避让。

- 信道选择的时机：BK5812模块启动与信道拥塞

BK5812模块启动，被配置成PRX模式时，会涉及到信道选择问题。至于信道拥塞检测，PRX自身想检测是比较困难的，当前寄存器中的信息不足以判断出来。执行流程大致如下：

（1）将模块配置成RX模式。

（2）选定信道，从最优信道区间2400~2402Mhz和2482~2500Mhz开始轮询。

（3）监听载波信号，读取寄存器CD，建议监听3次，每次间隔1ms，以防止蓝牙或wlan使用跳频传输的时候，间接影响到监听结果。

#### 2、网络发现与接入
- 目的：PTX需要一个发现网络的机制，并进行连接。
- 发现和接入过程可直接使用现成的smartconfig机制。
- 需要交互的数据包含工作信道、速率、包长、收发模型、是否支持auto-ack等配置参数。
- PTX的连接保活机制

当PRX突然断电或重启的时候，PTX需要进行重新连接。如果开启了auto-ack，PTX可以从PLOS_CNT丢包计数上来观察，如果持续丢包一段时间，则判定连接已断，需要进行重新连接。时分多址模型下，尽力传输不需要开启auto-ack，PTX可以依靠RF433来感知掉线。


#### 3、认证
- 暂不考虑，理应和smartconfig机制相关。
#### 4、收发模型
##### 4.1 时分多址
- 通过RF433协调时分

优点：干净与低干扰环境下，可以最大效率的传输数据。

缺点：遇到中度或重度干扰环境，重传和丢包会变得严重，再加上等待ACK的时间，在额定的时间范围内的速率会大大降低。

需要额外的RF433来配置传输，这会占用信道时间。切换过多，实时性好，速率低，切换过少，速率高，但实时性较差。

此模式下有两种策略：

（1）尽力传输，速率理应最高，这时候不配置auto-ack与重传，不要PID。

（2）可靠传输，需配置auto-ack与重传，也有可能需要PID。

收发流程大致如下：

（1）PRX采用轮询机制，使用RF433发送poll帧探寻PTX是否有包发送。

（2）PTX响应poll帧，如果无包发送，PRX轮询下一个PTX，有包则直接进行发送。

（3）PRX持续收包，并开启收包定时器。定时器超时之后，使RF433发送发包终止帧，PTX停止发包清理BK5812发包缓存。

##### 4.2 竞争传输
- 不需要RF433来配合传输

优点：充分利用信道，当其中一个点发送失败退避时，可以让其他节点继续发包。

缺点：干净与低干扰环境下，也会发生信号冲突导致的重传问题。

##### 4.3 重传算法
假设4Mbps的速率下，1ms可传输512byte，每个PTX的数据量是512KB/s，这将会占用信道128ms，可见在没有协调的情况下，4个PTX必然会带来冲突。

策略：

- 调整ARD（自动重传延迟），使每个PTX具有不同的ARD，以免冲突重复发生,但ARD的时间均是250us的整数倍，重复冲突的概率依然较高。
- 4Mbps速率下，传输256byte数据需要500us，因此ARD时间设置需要大于500us，同时可考虑降低包长，减少冲突。
- PTX发送一个重大缺陷在于无法载波监听，当发送256byte这种较长数据报文时，发送过程中无法感知到已经发生冲突，只有在没有收到ACK才能感知到可能发生了冲突，没有传输成功。因此，可配置可变包长，做个类似RTS/CTS机制传输报文。

大致流程如下：

（1）当PTX想要发送报文的时候，先传输一个最短长度的RTS请求报文。

（2）PRX接收RTS报文，通过ACK_PAY（ACK带回包数据）发送CTS给PTX，表示其可以发送数据。

（3）PTX如果没有收到CTS报文，则进行避让，等待下次传输。



##### 4.4 总结
BK5812基本属于单向传输模型，可以实现多发一收的星型网络。这种无线网络，冲突是首要考虑因素，PTX无法实现载波监听，检测不到冲突，单向传输模型，又导致不借助外在链路的情况下，PRX无法做到协调PTX的发送。因此，在干净与低干扰环境下，时分多址是有效方案，可有效避免冲突，提高速率，只是在遇到较强干扰时，传输效率会下降很快。竞争传输能有效提高信道效率，考虑好传输时机，中度干扰下应该竞争性能更优。

重度干扰下，就必须依靠拥塞检测来进行规避处理。


#### 5、流控
- 目的：当流量已超出PRX接收能力时，PRX需要对PTX进行通知。
- 通知策略有两个，一是依靠RF433来通知PTX，二是通过ACK_PAY通知。

2Mbps流量下，包长256byte，包数1024个，包长64byte，包数4096个。从测试结果来看，大包理应不会超出MCU接收能力，小包还待考证。

PTX接收到流控通知后，需要做相应处理，不然大量重传包会继续恶化无线环境，但因为没有类似TCP窗口机制，无法知道PRX具体可接收的报文数，这样的话，只能依靠降低速率（PRX是否可接收不同速率报文，待考证）或降低码率来适应。


#### 6、拥塞
- 目的：PTX需要做拥塞检测，当发现网络拥堵时，需要做相应处理。
- 检测机制：当PTX收到ACK后，会引发中断通知，可依靠此来计算RTT时间，判断拥塞情况。
- 当发生拥塞时，PTX可通知PRXP进行信道切换，也可自行降低速率（PRX是否可接收不同速率报文，待考证）或降低码率来适应。

#### 7、特性
- ACK包中可以携带数据
- 动态长度


